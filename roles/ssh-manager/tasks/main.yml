---
- name: Get passwd database on target
  ansible.builtin.getent:
    database: passwd
  register: getent_passwd_result

- name: Filter users that exist on the system
  ansible.builtin.set_fact:
    existing_unix_users: >-
      {{
        ssh_unix_users
        | intersect((getent_passwd_result.ansible_facts.getent_passwd | default({})).keys() | list)
      }}

- name: Process SSH keys for each existing unix user
  include_tasks: process_user.yml
  loop: "{{ existing_unix_users }}"
  loop_control:
    loop_var: unix_user
    label: "{{ unix_user }}"